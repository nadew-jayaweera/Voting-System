<!DOCTYPE html>
<html lang="en">
<head>
    <title>Live Results | Full Names</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 16px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: moveGrid 20s linear infinite;
            z-index: 0;
        }

        @keyframes moveGrid {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }
            50% { 
                opacity: 0.7;
                transform: scale(0.9);
                box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
            }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .shell { width: 100%; max-width: 1200px; display: flex; flex-direction: column; gap: 16px; position: relative; z-index: 1; }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.2rem;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .title-wrap h1 { 
            font-size: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .pill {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
        }

        .pill .value { font-size: 1.2rem; font-weight: 700; color: #667eea; }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* --- UPDATED GRID LAYOUT FOR FULL NAMES --- */
        .bar-graph-container {
            display: grid;
            /* Column 1: Exactly as wide as the longest name */
            /* Column 2: The rest of the screen for the bar */
            grid-template-columns: auto 1fr; 
            gap: 16px 24px;
            align-items: center;
        }

        .bar-label {
            font-weight: 700;
            color: #0f172a;
            font-size: 0.95rem;
            white-space: nowrap; /* Keeps name on one line */
            grid-column: 1;
        }

        .bar-wrapper {
            grid-column: 2;
            height: 38px;
            background: rgba(102, 126, 234, 0.08);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(102, 126, 234, 0.15);
            position: relative;
            width: 100%;
        }

        .bar-fill {
            height: 100%;
            width: 0%; 
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
        }

        .bar-value {
            color: white;
            font-weight: 800;
            font-size: 0.85rem;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            white-space: nowrap;
        }

        /* Responsive Mobile Layout */
        @media (max-width: 650px) {
            .bar-graph-container {
                grid-template-columns: 1fr; /* Stack name on top of bar */
                gap: 20px;
            }
            .bar-label { grid-column: 1; }
            .bar-wrapper { grid-column: 1; }
            .title-wrap h1 { font-size: 1.3rem; }
        }

        @media (min-width: 768px) {
            .title-wrap h1 { font-size: 2.2rem; }
            .pill .value { font-size: 1.6rem; }
        }

        /* --- CARDS --- */
        .candidates-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .candidate-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="shell">
        <div class="top-bar">
            <div class="title-wrap">
                <p style="color: #667eea; font-weight: 600; text-transform: uppercase; font-size: 0.7rem;">Live Competition</p>
                <h1>Live Results</h1>
            </div>
            <div class="status">
                <div class="pulse-dot" style="width:10px; height:10px; background:#22c55e; border-radius:50%; margin-right:8px; animation: pulse 1.5s ease-in-out infinite;"></div>
                <span style="font-size: 0.85rem; font-weight:700; color:#16a34a; animation: blink 2s ease-in-out infinite;">Live</span>
            </div>
        </div>

        <div class="meta">
            <div class="pill">
                <div style="color: #666; font-size: 0.8rem;">Total Votes</div>
                <div class="value" id="total-votes">0</div>
            </div>
            <div class="pill">
                <div style="color: #666; font-size: 0.8rem;">Last Update</div>
                <div class="value" id="last-update">â€”</div>
            </div>
        </div>

        <div class="panel">
            <h2 style="margin-bottom: 24px; font-size: 1.2rem;">Vote Distribution</h2>
            <div class="bar-graph-container" id="bar-graph">
                </div>
        </div>

        <div class="panel" style="background: transparent; box-shadow: none; padding: 0;">
            <div class="candidates-list" id="candidates-list"></div>
        </div>
    </div>

    <script>
        var socket = io();
        var totalVotesEl = document.getElementById('total-votes');
        var lastUpdateEl = document.getElementById('last-update');
        
        // Live clock update every second
        function updateClock() {
            const now = new Date();
            lastUpdateEl.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        }
        
        // Update clock immediately and then every second
        updateClock();
        setInterval(updateClock, 1000);
        
        var palette = [
            { bg: 'rgba(125, 211, 252, 0.9)', border: 'rgb(14, 165, 233)' },
            { bg: 'rgba(192, 132, 252, 0.9)', border: 'rgb(147, 51, 234)' },
            { bg: 'rgba(244, 114, 182, 0.9)', border: 'rgb(219, 39, 119)' },
            { bg: 'rgba(96, 165, 250, 0.9)', border: 'rgb(37, 99, 235)' },
            { bg: 'rgba(52, 211, 153, 0.9)', border: 'rgb(16, 185, 129)' }
        ];

        function toTitleCase(str) {
            return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
        }

        function refreshChart(scores) {
            if (!scores || Object.keys(scores).length === 0) return;

            const ids = Object.keys(scores);
            const voteData = ids.map((id, index) => ({
                id: id,
                index: index,
                name: scores[id].name || ('Candidate ' + id),
                votes: scores[id].votes || 0
            }));

            const totalVotes = voteData.reduce((sum, item) => sum + item.votes, 0);
            const rankedData = [...voteData].sort((a, b) => b.votes - a.votes);

            const barGraphEl = document.getElementById('bar-graph');
            
            // Note: Since we use CSS Grid for layout, we can't easily use 'order' 
            // for the labels and wrappers separately. Instead, we re-render 
            // the grid children in the ranked order to keep names and bars aligned.
            barGraphEl.innerHTML = ''; 

            rankedData.forEach((item) => {
                const percentage = totalVotes > 0 ? Math.round((item.votes / totalVotes) * 100) : 0;
                const color = palette[item.index % palette.length];
                
                // Create Name Label
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = item.name;
                
                // Create Bar Wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'bar-wrapper';
                
                const fill = document.createElement('div');
                fill.className = 'bar-fill';        
                fill.id = 'fill-' + item.id;
                fill.style.background = `linear-gradient(90deg, ${color.border}, ${color.bg})`;
                fill.innerHTML = `<div class="bar-value">${item.votes.toLocaleString()} (${percentage}%)</div>`;
                
                wrapper.appendChild(fill);
                barGraphEl.appendChild(label);
                barGraphEl.appendChild(wrapper);

                // Trigger growth animation
                setTimeout(() => {
                    fill.style.width = percentage + '%';
                }, 50);
            });

            // UPDATE CARDS
            const cardsListEl = document.getElementById('candidates-list');
            cardsListEl.innerHTML = '';
            rankedData.forEach((item, index) => {
                const percentage = totalVotes > 0 ? Math.round((item.votes / totalVotes) * 100) : 0;
                const rank = index + 1;
                const card = document.createElement('div');
                card.className = 'candidate-card';
                card.innerHTML = `
                    <div>
                        <div style="font-weight:700;">${rank === 1 ? 'ðŸ‘‘ ' : ''}${item.name}</div>
                        <div style="color:#64748b; font-size:0.75rem;">ID: ${item.id}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:1.2rem; font-weight:800; color:#667eea;">${item.votes.toLocaleString()}</div>
                        <div style="color:#667eea; font-weight:700; font-size:0.8rem;">${percentage}%</div>
                    </div>
                `;
                cardsListEl.appendChild(card);
            });

            totalVotesEl.textContent = totalVotes.toLocaleString();
            // Clock updates automatically via setInterval, no need to update here
        }

        socket.on('update_scores', function(scores) {
            refreshChart(scores);
        });
    </script>
</body>
</html>